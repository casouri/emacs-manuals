<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<!-- This is the GNU Emacs Lisp Reference Manual
corresponding to Emacs version 29.0.50.

Copyright Â© 1990-1996, 1998-2021 Free Software Foundation,
Inc.

Permission is granted to copy, distribute and/or modify this document
under the terms of the GNU Free Documentation License, Version 1.3 or
any later version published by the Free Software Foundation; with the
Invariant Sections being "GNU General Public License," with the
Front-Cover Texts being "A GNU Manual," and with the Back-Cover
Texts as in (a) below.  A copy of the license is included in the
section entitled "GNU Free Documentation License."

(a) The FSF's Back-Cover Text is: "You have the freedom to copy and
modify this GNU manual.  Buying copies from the FSF supports it in
developing GNU and promoting software freedom." -->
<!-- Created by GNU Texinfo 6.7, http://www.gnu.org/software/texinfo/ -->
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<title>Bindat Computed Types (GNU Emacs Lisp Reference Manual)</title>

<meta name="description" content="Bindat Computed Types (GNU Emacs Lisp Reference Manual)">
<meta name="keywords" content="Bindat Computed Types (GNU Emacs Lisp Reference Manual)">
<meta name="resource-type" content="document">
<meta name="distribution" content="global">
<meta name="Generator" content="makeinfo">
<link href="index.html" rel="start" title="Top">
<link href="Index.html" rel="index" title="Index">
<link href="index.html#SEC_Contents" rel="contents" title="Table of Contents">
<link href="Byte-Packing.html" rel="up" title="Byte Packing">
<link href="Display.html" rel="next" title="Display">
<link href="Bindat-Functions.html" rel="prev" title="Bindat Functions">
<style type="text/css">
<!--
a.summary-letter {text-decoration: none}
blockquote.indentedblock {margin-right: 0em}
div.display {margin-left: 3.2em}
div.example {margin-left: 3.2em}
div.lisp {margin-left: 3.2em}
kbd {font-style: oblique}
pre.display {font-family: inherit}
pre.format {font-family: inherit}
pre.menu-comment {font-family: serif}
pre.menu-preformatted {font-family: serif}
span.nolinebreak {white-space: nowrap}
span.roman {font-family: initial; font-weight: normal}
span.sansserif {font-family: sans-serif; font-weight: normal}
ul.no-bullet {list-style: none}
-->
</style>
<link rel="stylesheet" type="text/css" href="./manual.css">


</head>

<body lang="en">
<span id="Bindat-Computed-Types"></span><div class="header">
<p>
Previous: <a href="Bindat-Functions.html" accesskey="p" rel="prev">Bindat Functions</a>, Up: <a href="Byte-Packing.html" accesskey="u" rel="up">Byte Packing</a> &nbsp; [<a href="index.html#SEC_Contents" title="Table of contents" rel="contents">Contents</a>][<a href="Index.html" title="Index" rel="index">Index</a>]</p>
</div>
<hr>
<span id="Advanced-data-layout-specifications"></span><h4 class="subsection">39.20.3 Advanced data layout specifications</h4>
<span id="index-bindat-computed-types"></span>

<p>Bindat type expressions are not limited to the types described
earlier.  They can also be arbitrary Lisp forms returning Bindat
type expressions.  For example, the type below describes data which
can either contain a 24-bit error code or a vector of bytes:
</p>
<div class="example">
<pre class="example">(bindat-type
  (len      u8)
  (payload  . (if (zerop len) (uint 24) (vec (1- len)))))
</pre></div>

<span id="index-bindat-packing-and-unpacking-into-arbitrary-types"></span>
<p>Furthermore, while composite types are normally unpacked to (and
packed from) association lists, this can be changed via the use of
the following special keyword arguments:
</p>
<dl compact="compact">
<dt><code>:unpack-val <var>exp</var></code></dt>
<dd><p>When the list of fields ends with this keyword argument, then the value
returned when unpacking is the value of <var>exp</var> instead of the
standard alist.  <var>exp</var> can refer to all the previous fields by
their name.
</p>
</dd>
<dt><code>:pack-val <var>exp</var></code></dt>
<dd><p>If a field&rsquo;s type is followed by this keyword argument, then the value
packed into this field is returned by <var>exp</var> instead of being
extracted from the alist.
</p>
</dd>
<dt><code>:pack-var <var>name</var></code></dt>
<dd><p>If the list of fields is preceded by this keyword argument, then all
the subsequent <code>:pack-val</code> arguments can refer to the overall
value to pack into this composite type via the variable named
<var>name</var>.
</p></dd>
</dl>

<p>For example, one could describe a 16-bit signed integer as follows:
</p>
<div class="example">
<pre class="example">(defconst sint16-bindat-spec
  (let* ((max (ash 1 15))
         (wrap (+ max max)))
    (bindat-type :pack-var v
                 (n uint 16 :pack-val (if (&lt; v 0) (+ v wrap) v))
                 :unpack-val (if (&gt;= n max) (- n wrap) n))))
</pre></div>

<p>Which would then behave as follows:
</p><div class="example">
<pre class="example">(bindat-pack sint16-bindat-spec -8)
     &rArr; &quot;\377\370&quot;

(bindat-unpack sint16-bindat-spec &quot;\300\100&quot;)
     &rArr; -16320
</pre></div>

<span id="index-define-new-bindat-type-forms"></span>
<span id="index-bindat_002c-define-new-type-forms"></span>
<p>Finally, you can define new Bindat type forms to use in Bindat type
expressions with <code>bindat-defmacro</code>:
</p>
<dl>
<dt id="index-bindat_002ddefmacro">Macro: <strong>bindat-defmacro</strong> <em>name args &amp;rest body</em></dt>
<dd><p>Define a new Bindat type expression named <var>name</var> and taking
arguments <var>args</var>.  Its behavior follows that of <code>defmacro</code>,
which the important difference that the new forms can only be used
within Bindat type expressions.
</p></dd></dl>

<hr>
<div class="header">
<p>
Previous: <a href="Bindat-Functions.html" accesskey="p" rel="prev">Bindat Functions</a>, Up: <a href="Byte-Packing.html" accesskey="u" rel="up">Byte Packing</a> &nbsp; [<a href="index.html#SEC_Contents" title="Table of contents" rel="contents">Contents</a>][<a href="Index.html" title="Index" rel="index">Index</a>]</p>
</div>



</body>
</html>
