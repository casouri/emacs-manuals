<!DOCTYPE html>
<html>
<!-- Created by GNU Texinfo 7.1, https://www.gnu.org/software/texinfo/ -->
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<!-- This is the GNU Emacs Lisp Reference Manual
corresponding to Emacs version 31.0.50.

Copyright Â© 1990-1996, 1998-2025 Free Software Foundation,
Inc.

Permission is granted to copy, distribute and/or modify this document
under the terms of the GNU Free Documentation License, Version 1.3 or
any later version published by the Free Software Foundation; with the
Invariant Sections being "GNU General Public License," with the
Front-Cover Texts being "A GNU Manual," and with the Back-Cover
Texts as in (a) below.  A copy of the license is included in the
section entitled "GNU Free Documentation License."

(a) The FSF's Back-Cover Text is: "You have the freedom to copy and
modify this GNU manual.  Buying copies from the FSF supports it in
developing GNU and promoting software freedom." -->
<title>Bindat Computed Types (GNU Emacs Lisp Reference Manual)</title>

<meta name="description" content="Bindat Computed Types (GNU Emacs Lisp Reference Manual)">
<meta name="keywords" content="Bindat Computed Types (GNU Emacs Lisp Reference Manual)">
<meta name="resource-type" content="document">
<meta name="distribution" content="global">
<meta name="Generator" content="makeinfo">
<meta name="viewport" content="width=device-width,initial-scale=1">

<link href="index.html" rel="start" title="Top">
<link href="Index.html" rel="index" title="Index">
<link href="index.html#SEC_Contents" rel="contents" title="Table of Contents">
<link href="Byte-Packing.html" rel="up" title="Byte Packing">
<link href="Bindat-Functions.html" rel="prev" title="Bindat Functions">
<style type="text/css">
<!--
a.copiable-link {visibility: hidden; text-decoration: none; line-height: 0em}
div.example {margin-left: 3.2em}
span:hover a.copiable-link {visibility: visible}
strong.def-name {font-family: monospace; font-weight: bold; font-size: larger}
-->
</style>
<link rel="stylesheet" type="text/css" href="./manual.css">


</head>

<body lang="en">
<div class="subsection-level-extent" id="Bindat-Computed-Types">
<div class="nav-panel">
<p>
Previous: <a href="Bindat-Functions.html" accesskey="p" rel="prev">Functions to Unpack and Pack Bytes</a>, Up: <a href="Byte-Packing.html" accesskey="u" rel="up">Packing and Unpacking Byte Arrays</a> &nbsp; [<a href="index.html#SEC_Contents" title="Table of contents" rel="contents">Contents</a>][<a href="Index.html" title="Index" rel="index">Index</a>]</p>
</div>
<hr>
<h4 class="subsection" id="Advanced-data-layout-specifications"><span>41.20.3 Advanced data layout specifications<a class="copiable-link" href="#Advanced-data-layout-specifications"> &para;</a></span></h4>
<a class="index-entry-id" id="index-bindat-computed-types"></a>

<p>Bindat type expressions are not limited to the types described
earlier.  They can also be arbitrary Lisp forms returning Bindat
type expressions.  For example, the type below describes data which
can either contain a 24-bit error code or a vector of bytes:
</p>
<div class="example">
<pre class="example-preformatted">(bindat-type
  (len      u8)
  (payload  . (if (zerop len) (uint 24) (vec (1- len)))))
</pre></div>

<a class="index-entry-id" id="index-bindat-packing-and-unpacking-into-arbitrary-types"></a>
<p>Furthermore, while composite types are normally unpacked to (and
packed from) association lists, this can be changed via the use of
the following special keyword arguments:
</p>
<dl class="table">
<dt><code class="code">:unpack-val <var class="var">exp</var></code></dt>
<dd><p>When the list of fields ends with this keyword argument, then the value
returned when unpacking is the value of <var class="var">exp</var> instead of the
standard alist.  <var class="var">exp</var> can refer to all the previous fields by
their name.
</p>
</dd>
<dt><code class="code">:pack-val <var class="var">exp</var></code></dt>
<dd><p>If a field&rsquo;s type is followed by this keyword argument, then the value
packed into this field is returned by <var class="var">exp</var> instead of being
extracted from the alist.
</p>
</dd>
<dt><code class="code">:pack-var <var class="var">name</var></code></dt>
<dd><p>If the list of fields is preceded by this keyword argument, then all
the subsequent <code class="code">:pack-val</code> arguments can refer to the overall
value to pack into this composite type via the variable named
<var class="var">name</var>.
</p></dd>
</dl>

<p>For example, one could describe a 16-bit signed integer as follows:
</p>
<div class="example">
<pre class="example-preformatted">(defconst sint16-bindat-spec
  (let* ((max (ash 1 15))
         (wrap (+ max max)))
    (bindat-type :pack-var v
                 (n uint 16 :pack-val (if (&lt; v 0) (+ v wrap) v))
                 :unpack-val (if (&gt;= n max) (- n wrap) n))))
</pre></div>

<p>Which would then behave as follows:
</p><div class="example">
<pre class="example-preformatted">(bindat-pack sint16-bindat-spec -8)
     &rArr; &quot;\377\370&quot;

(bindat-unpack sint16-bindat-spec &quot;\300\100&quot;)
     &rArr; -16320
</pre></div>

<a class="index-entry-id" id="index-define-new-bindat-type-forms"></a>
<a class="index-entry-id" id="index-bindat_002c-define-new-type-forms"></a>
<p>Finally, you can define new Bindat type forms to use in Bindat type
expressions with <code class="code">bindat-defmacro</code>:
</p>
<dl class="first-deffn first-defmac-alias-first-deffn">
<dt class="deffn defmac-alias-deffn" id="index-bindat_002ddefmacro"><span class="category-def">Macro: </span><span><strong class="def-name">bindat-defmacro</strong> <var class="def-var-arguments">name args &amp;rest body</var><a class="copiable-link" href="#index-bindat_002ddefmacro"> &para;</a></span></dt>
<dd><p>Define a new Bindat type expression named <var class="var">name</var> and taking
arguments <var class="var">args</var>.  Its behavior follows that of <code class="code">defmacro</code>,
which the important difference that the new forms can only be used
within Bindat type expressions.
</p></dd></dl>

</div>
<hr>
<div class="nav-panel">
<p>
Previous: <a href="Bindat-Functions.html">Functions to Unpack and Pack Bytes</a>, Up: <a href="Byte-Packing.html">Packing and Unpacking Byte Arrays</a> &nbsp; [<a href="index.html#SEC_Contents" title="Table of contents" rel="contents">Contents</a>][<a href="Index.html" title="Index" rel="index">Index</a>]</p>
</div>



</body>
</html>
