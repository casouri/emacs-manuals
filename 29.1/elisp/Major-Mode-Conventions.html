<!DOCTYPE html>
<html>
<!-- Created by GNU Texinfo 7.1, https://www.gnu.org/software/texinfo/ -->
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<!-- This is the GNU Emacs Lisp Reference Manual
corresponding to Emacs version 29.1.

Copyright Â© 1990-1996, 1998-2023 Free Software Foundation,
Inc.

Permission is granted to copy, distribute and/or modify this document
under the terms of the GNU Free Documentation License, Version 1.3 or
any later version published by the Free Software Foundation; with the
Invariant Sections being "GNU General Public License," with the
Front-Cover Texts being "A GNU Manual," and with the Back-Cover
Texts as in (a) below.  A copy of the license is included in the
section entitled "GNU Free Documentation License."

(a) The FSF's Back-Cover Text is: "You have the freedom to copy and
modify this GNU manual.  Buying copies from the FSF supports it in
developing GNU and promoting software freedom." -->
<title>Major Mode Conventions (GNU Emacs Lisp Reference Manual)</title>

<meta name="description" content="Major Mode Conventions (GNU Emacs Lisp Reference Manual)">
<meta name="keywords" content="Major Mode Conventions (GNU Emacs Lisp Reference Manual)">
<meta name="resource-type" content="document">
<meta name="distribution" content="global">
<meta name="Generator" content="makeinfo">
<meta name="viewport" content="width=device-width,initial-scale=1">

<link href="index.html" rel="start" title="Top">
<link href="Index.html" rel="index" title="Index">
<link href="index.html#SEC_Contents" rel="contents" title="Table of Contents">
<link href="Major-Modes.html" rel="up" title="Major Modes">
<link href="Auto-Major-Mode.html" rel="next" title="Auto Major Mode">
<style type="text/css">
<!--
a.copiable-link {visibility: hidden; text-decoration: none; line-height: 0em}
div.example {margin-left: 3.2em}
kbd.kbd {font-style: oblique}
kbd.key {font-style: normal}
span:hover a.copiable-link {visibility: visible}
ul.mark-bullet {list-style-type: disc}
-->
</style>
<link rel="stylesheet" type="text/css" href="./manual.css">


</head>

<body lang="en">
<div class="subsection-level-extent" id="Major-Mode-Conventions">
<div class="nav-panel">
<p>
Next: <a href="Auto-Major-Mode.html" accesskey="n" rel="next">How Emacs Chooses a Major Mode</a>, Up: <a href="Major-Modes.html" accesskey="u" rel="up">Major Modes</a> &nbsp; [<a href="index.html#SEC_Contents" title="Table of contents" rel="contents">Contents</a>][<a href="Index.html" title="Index" rel="index">Index</a>]</p>
</div>
<hr>
<h4 class="subsection" id="Major-Mode-Conventions-1"><span>24.2.1 Major Mode Conventions<a class="copiable-link" href="#Major-Mode-Conventions-1"> &para;</a></span></h4>
<a class="index-entry-id" id="index-major-mode-conventions"></a>
<a class="index-entry-id" id="index-conventions-for-writing-major-modes"></a>

<p>The code for every major mode should follow various coding
conventions, including conventions for local keymap and syntax table
initialization, function and variable names, and hooks.
</p>
<p>If you use the <code class="code">define-derived-mode</code> macro, it will take care of
many of these conventions automatically.  See <a class="xref" href="Derived-Modes.html">Defining Derived Modes</a>.  Note
also that Fundamental mode is an exception to many of these conventions,
because it represents the default state of Emacs.
</p>
<p>The following list of conventions is only partial.  Each major mode
should aim for consistency in general with other Emacs major modes, as
this makes Emacs as a whole more coherent.  It is impossible to list
here all the possible points where this issue might come up; if the
Emacs developers point out an area where your major mode deviates from
the usual conventions, please make it compatible.
</p>
<ul class="itemize mark-bullet">
<li>Define a major mode command whose name ends in &lsquo;<samp class="samp">-mode</samp>&rsquo;.  When
called with no arguments, this command should switch to the new mode in
the current buffer by setting up the keymap, syntax table, and
buffer-local variables in an existing buffer.  It should not change the
buffer&rsquo;s contents.

</li><li>Write a documentation string for this command that describes the special
commands available in this mode.  See <a class="xref" href="Mode-Help.html">Getting Help about a Major Mode</a>.

<p>The documentation string may include the special documentation
substrings, &lsquo;<samp class="samp">\[<var class="var">command</var>]</samp>&rsquo;, &lsquo;<samp class="samp">\{<var class="var">keymap</var>}</samp>&rsquo;, and
&lsquo;<samp class="samp">\&lt;<var class="var">keymap</var>&gt;</samp>&rsquo;, which allow the help display to adapt
automatically to the user&rsquo;s own key bindings.  See <a class="xref" href="Keys-in-Documentation.html">Substituting Key Bindings in Documentation</a>.
</p>
</li><li>The major mode command should start by calling
<code class="code">kill-all-local-variables</code>.  This runs the normal hook
<code class="code">change-major-mode-hook</code>, then gets rid of the buffer-local
variables of the major mode previously in effect.  See <a class="xref" href="Creating-Buffer_002dLocal.html">Creating and Deleting Buffer-Local Bindings</a>.

</li><li>The major mode command should set the variable <code class="code">major-mode</code> to the
major mode command symbol.  This is how <code class="code">describe-mode</code> discovers
which documentation to print.

</li><li>The major mode command should set the variable <code class="code">mode-name</code> to the
&ldquo;pretty&rdquo; name of the mode, usually a string (but see <a class="ref" href="Mode-Line-Data.html">The Data Structure of the Mode Line</a>, for other possible forms).  The name of the mode appears
in the mode line.

</li><li>Calling the major mode command twice in direct succession should not
fail and should do the same thing as calling the command only once.
In other words, the major mode command should be idempotent.

</li><li><a class="index-entry-id" id="index-functions-in-modes"></a>
Since all global names are in the same name space, all the global
variables, constants, and functions that are part of the mode should
have names that start with the major mode name (or with an abbreviation
of it if the name is long).  See <a class="xref" href="Coding-Conventions.html">Emacs Lisp Coding Conventions</a>.

</li><li>In a major mode for editing some kind of structured text, such as a
programming language, indentation of text according to structure is
probably useful.  So the mode should set <code class="code">indent-line-function</code>
to a suitable function, and probably customize other variables
for indentation.  See <a class="xref" href="Auto_002dIndentation.html">Automatic Indentation of code</a>.

</li><li><a class="index-entry-id" id="index-keymaps-in-modes"></a>
The major mode should usually have its own keymap, which is used as the
local keymap in all buffers in that mode.  The major mode command should
call <code class="code">use-local-map</code> to install this local map.  See <a class="xref" href="Active-Keymaps.html">Active Keymaps</a>, for more information.

<p>This keymap should be stored permanently in a global variable named
<code class="code"><var class="var">modename</var>-mode-map</code>.  Normally the library that defines the
mode sets this variable.
</p>
<p>See <a class="xref" href="Tips-for-Defining.html">Tips for Defining Variables Robustly</a>, for advice about how to write the code to set
up the mode&rsquo;s keymap variable.
</p>
</li><li>The key sequences bound in a major mode keymap should usually start with
<kbd class="kbd">C-c</kbd>, followed by a control character, a digit, or <kbd class="kbd">{</kbd>,
<kbd class="kbd">}</kbd>, <kbd class="kbd">&lt;</kbd>, <kbd class="kbd">&gt;</kbd>, <kbd class="kbd">:</kbd> or <kbd class="kbd">;</kbd>.  The other punctuation
characters are reserved for minor modes, and ordinary letters are
reserved for users.

<p>A major mode can also rebind the keys <kbd class="kbd">M-n</kbd>, <kbd class="kbd">M-p</kbd> and
<kbd class="kbd">M-s</kbd>.  The bindings for <kbd class="kbd">M-n</kbd> and <kbd class="kbd">M-p</kbd> should normally
be some kind of moving forward and backward, but this does not
necessarily mean cursor motion.
</p>
<p>It is legitimate for a major mode to rebind a standard key sequence if
it provides a command that does the same job in a way better
suited to the text this mode is used for.  For example, a major mode
for editing a programming language might redefine <kbd class="kbd">C-M-a</kbd> to
move to the beginning of a function in a way that works better for
that language.  The recommended way of tailoring <kbd class="kbd">C-M-a</kbd> to the
needs of a major mode is to set <code class="code">beginning-of-defun-function</code>
(see <a class="pxref" href="List-Motion.html">Moving over Balanced Expressions</a>) to invoke the function specific to the mode.
</p>
<p>It is also legitimate for a major mode to rebind a standard key
sequence whose standard meaning is rarely useful in that mode.  For
instance, minibuffer modes rebind <kbd class="kbd">M-r</kbd>, whose standard meaning is
rarely of any use in the minibuffer.  Major modes such as Dired or
Rmail that do not allow self-insertion of text can reasonably redefine
letters and other printing characters as special commands.
</p>
</li><li>Major modes for editing text should not define <kbd class="key">RET</kbd> to do
anything other than insert a newline.  However, it is ok for
specialized modes for text that users don&rsquo;t directly edit, such as
Dired and Info modes, to redefine <kbd class="key">RET</kbd> to do something entirely
different.

</li><li>Major modes should not alter options that are primarily a matter of user
preference, such as whether Auto-Fill mode is enabled.  Leave this to
each user to decide.  However, a major mode should customize other
variables so that Auto-Fill mode will work usefully <em class="emph">if</em> the user
decides to use it.

</li><li><a class="index-entry-id" id="index-syntax-tables-in-modes"></a>
The mode may have its own syntax table or may share one with other
related modes.  If it has its own syntax table, it should store this in
a variable named <code class="code"><var class="var">modename</var>-mode-syntax-table</code>.  See <a class="xref" href="Syntax-Tables.html">Syntax Tables</a>.

</li><li>If the mode handles a language that has a syntax for comments, it should
set the variables that define the comment syntax.  See <a data-manual="emacs" href="https://www.gnu.org/software/emacs/manual/html_node/emacs/Options-for-Comments.html#Options-for-Comments">Options Controlling Comments</a> in <cite class="cite">The GNU Emacs Manual</cite>.

</li><li><a class="index-entry-id" id="index-abbrev-tables-in-modes"></a>
The mode may have its own abbrev table or may share one with other
related modes.  If it has its own abbrev table, it should store this
in a variable named <code class="code"><var class="var">modename</var>-mode-abbrev-table</code>.  If the
major mode command defines any abbrevs itself, it should pass <code class="code">t</code>
for the <var class="var">system-flag</var> argument to <code class="code">define-abbrev</code>.
See <a class="xref" href="Defining-Abbrevs.html">Defining Abbrevs</a>.

</li><li>The mode should specify how to do highlighting for Font Lock mode, by
setting up a buffer-local value for the variable
<code class="code">font-lock-defaults</code> (see <a class="pxref" href="Font-Lock-Mode.html">Font Lock Mode</a>).

</li><li>Each face that the mode defines should, if possible, inherit from an
existing Emacs face.  See <a class="xref" href="Basic-Faces.html">Basic Faces</a>, and <a class="ref" href="Faces-for-Font-Lock.html">Faces for Font Lock</a>.

</li><li>Consider adding a mode-specific menu to the menu bar.  This should
preferably include the most important menu-specific settings and
commands that will allow users discovering the main features quickly
and efficiently.

</li><li><a class="index-entry-id" id="index-context-menus_002c-for-a-major-mode"></a>
<a class="index-entry-id" id="index-context_002dmenu_002dfunctions"></a>
Consider adding mode-specific context menus for the mode, to be used
if and when users activate the <code class="code">context-menu-mode</code> (see <a data-manual="emacs" href="https://www.gnu.org/software/emacs/manual/html_node/emacs/Menu-Mouse-Clicks.html#Menu-Mouse-Clicks">Menu
Mouse Clicks</a> in <cite class="cite">The Emacs Manual</cite>).  To this end, define a
mode-specific function which builds one or more menus depending on the
location of the <kbd class="kbd">mouse-3</kbd> click in the buffer, and then add that
function to the buffer-local value of <code class="code">context-menu-functions</code>.

</li><li>The mode should specify how Imenu should find the definitions or
sections of a buffer, by setting up a buffer-local value for the
variable <code class="code">imenu-generic-expression</code>, for the two variables
<code class="code">imenu-prev-index-position-function</code> and
<code class="code">imenu-extract-index-name-function</code>, or for the variable
<code class="code">imenu-create-index-function</code> (see <a class="pxref" href="Imenu.html">Imenu</a>).

</li><li>The mode can tell ElDoc mode how to retrieve different types of
documentation for whatever is at point, by adding one or more
buffer-local entries to the special hook
<code class="code">eldoc-documentation-functions</code>.

</li><li>The mode can specify how to complete various keywords by adding one or
more buffer-local entries to the special hook
<code class="code">completion-at-point-functions</code>.  See <a class="xref" href="Completion-in-Buffers.html">Completion in Ordinary Buffers</a>.

</li><li><a class="index-entry-id" id="index-buffer_002dlocal-variables-in-modes"></a>
To make a buffer-local binding for an Emacs customization variable, use
<code class="code">make-local-variable</code> in the major mode command, not
<code class="code">make-variable-buffer-local</code>.  The latter function would make the
variable local to every buffer in which it is subsequently set, which
would affect buffers that do not use this mode.  It is undesirable for a
mode to have such global effects.  See <a class="xref" href="Buffer_002dLocal-Variables.html">Buffer-Local Variables</a>.

<p>With rare exceptions, the only reasonable way to use
<code class="code">make-variable-buffer-local</code> in a Lisp package is for a variable
which is used only within that package.  Using it on a variable used by
other packages would interfere with them.
</p>
</li><li><a class="index-entry-id" id="index-mode-hook"></a>
<a class="index-entry-id" id="index-major-mode-hook"></a>
Each major mode should have a normal <em class="dfn">mode hook</em> named
<code class="code"><var class="var">modename</var>-mode-hook</code>.  The very last thing the major mode command
should do is to call <code class="code">run-mode-hooks</code>.  This runs the normal
hook <code class="code">change-major-mode-after-body-hook</code>, the mode hook, the
function <code class="code">hack-local-variables</code> (when the buffer is visiting a file),
and then the normal hook <code class="code">after-change-major-mode-hook</code>.
See <a class="xref" href="Mode-Hooks.html">Mode Hooks</a>.

</li><li>The major mode command may start by calling some other major mode
command (called the <em class="dfn">parent mode</em>) and then alter some of its
settings.  A mode that does this is called a <em class="dfn">derived mode</em>.  The
recommended way to define one is to use the <code class="code">define-derived-mode</code>
macro, but this is not required.  Such a mode should call the parent
mode command inside a <code class="code">delay-mode-hooks</code> form.  (Using
<code class="code">define-derived-mode</code> does this automatically.)  See <a class="xref" href="Derived-Modes.html">Defining Derived Modes</a>, and <a class="ref" href="Mode-Hooks.html">Mode Hooks</a>.

</li><li>If something special should be done if the user switches a buffer from
this mode to any other major mode, this mode can set up a buffer-local
value for <code class="code">change-major-mode-hook</code> (see <a class="pxref" href="Creating-Buffer_002dLocal.html">Creating and Deleting Buffer-Local Bindings</a>).

</li><li>If this mode is appropriate only for specially-prepared text produced by
the mode itself (rather than by the user typing at the keyboard or by an
external file), then the major mode command symbol should have a
property named <code class="code">mode-class</code> with value <code class="code">special</code>, put on as
follows:

<a class="index-entry-id" id="index-mode_002dclass-_0028property_0029"></a>
<a class="index-entry-id" id="index-special-modes"></a>
<div class="example">
<pre class="example-preformatted">(put 'funny-mode 'mode-class 'special)
</pre></div>

<p>This tells Emacs that new buffers created while the current buffer is in
Funny mode should not be put in Funny mode, even though the default
value of <code class="code">major-mode</code> is <code class="code">nil</code>.  By default, the value of
<code class="code">nil</code> for <code class="code">major-mode</code> means to use the current buffer&rsquo;s major
mode when creating new buffers (see <a class="pxref" href="Auto-Major-Mode.html">How Emacs Chooses a Major Mode</a>), but with such
<code class="code">special</code> modes, Fundamental mode is used instead.  Modes such as
Dired, Rmail, and Buffer List use this feature.
</p>
<p>The function <code class="code">view-buffer</code> does not enable View mode in buffers
whose mode-class is special, because such modes usually provide their
own View-like bindings.
</p>
<p>The <code class="code">define-derived-mode</code> macro automatically marks the derived
mode as special if the parent mode is special.  Special mode is a
convenient parent for such modes to inherit from; See <a class="xref" href="Basic-Major-Modes.html">Basic Major Modes</a>.
</p>
</li><li>If you want to make the new mode the default for files with certain
recognizable names, add an element to <code class="code">auto-mode-alist</code> to select
the mode for those file names (see <a class="pxref" href="Auto-Major-Mode.html">How Emacs Chooses a Major Mode</a>).  If you
define the mode command to autoload, you should add this element in
the same file that calls <code class="code">autoload</code>.  If you use an autoload
cookie for the mode command, you can also use an autoload cookie for
the form that adds the element (see <a class="pxref" href="Autoload.html#autoload-cookie">autoload cookie</a>).  If you do
not autoload the mode command, it is sufficient to add the element in
the file that contains the mode definition.

</li><li><a class="index-entry-id" id="index-mode-loading"></a>
The top-level forms in the file defining the mode should be written so
that they may be evaluated more than once without adverse consequences.
For instance, use <code class="code">defvar</code> or <code class="code">defcustom</code> to set mode-related
variables, so that they are not reinitialized if they already have a
value (see <a class="pxref" href="Defining-Variables.html">Defining Global Variables</a>).

</li></ul>

</div>
<hr>
<div class="nav-panel">
<p>
Next: <a href="Auto-Major-Mode.html">How Emacs Chooses a Major Mode</a>, Up: <a href="Major-Modes.html">Major Modes</a> &nbsp; [<a href="index.html#SEC_Contents" title="Table of contents" rel="contents">Contents</a>][<a href="Index.html" title="Index" rel="index">Index</a>]</p>
</div>



</body>
</html>
