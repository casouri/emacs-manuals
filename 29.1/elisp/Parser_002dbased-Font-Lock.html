<!DOCTYPE html>
<html>
<!-- Created by GNU Texinfo 7.1, https://www.gnu.org/software/texinfo/ -->
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<!-- This is the GNU Emacs Lisp Reference Manual
corresponding to Emacs version 29.1.

Copyright Â© 1990-1996, 1998-2023 Free Software Foundation,
Inc.

Permission is granted to copy, distribute and/or modify this document
under the terms of the GNU Free Documentation License, Version 1.3 or
any later version published by the Free Software Foundation; with the
Invariant Sections being "GNU General Public License," with the
Front-Cover Texts being "A GNU Manual," and with the Back-Cover
Texts as in (a) below.  A copy of the license is included in the
section entitled "GNU Free Documentation License."

(a) The FSF's Back-Cover Text is: "You have the freedom to copy and
modify this GNU manual.  Buying copies from the FSF supports it in
developing GNU and promoting software freedom." -->
<title>Parser-based Font Lock (GNU Emacs Lisp Reference Manual)</title>

<meta name="description" content="Parser-based Font Lock (GNU Emacs Lisp Reference Manual)">
<meta name="keywords" content="Parser-based Font Lock (GNU Emacs Lisp Reference Manual)">
<meta name="resource-type" content="document">
<meta name="distribution" content="global">
<meta name="Generator" content="makeinfo">
<meta name="viewport" content="width=device-width,initial-scale=1">

<link href="index.html" rel="start" title="Top">
<link href="Index.html" rel="index" title="Index">
<link href="index.html#SEC_Contents" rel="contents" title="Table of Contents">
<link href="Font-Lock-Mode.html" rel="up" title="Font Lock Mode">
<link href="Multiline-Font-Lock.html" rel="prev" title="Multiline Font Lock">
<style type="text/css">
<!--
a.copiable-link {visibility: hidden; text-decoration: none; line-height: 0em}
div.example {margin-left: 3.2em}
span:hover a.copiable-link {visibility: visible}
strong.def-name {font-family: monospace; font-weight: bold; font-size: larger}
ul.mark-bullet {list-style-type: disc}
-->
</style>
<link rel="stylesheet" type="text/css" href="./manual.css">


</head>

<body lang="en">
<div class="subsection-level-extent" id="Parser_002dbased-Font-Lock">
<div class="nav-panel">
<p>
Previous: <a href="Multiline-Font-Lock.html" accesskey="p" rel="prev">Multiline Font Lock Constructs</a>, Up: <a href="Font-Lock-Mode.html" accesskey="u" rel="up">Font Lock Mode</a> &nbsp; [<a href="index.html#SEC_Contents" title="Table of contents" rel="contents">Contents</a>][<a href="Index.html" title="Index" rel="index">Index</a>]</p>
</div>
<hr>
<h4 class="subsection" id="Parser_002dbased-Font-Lock-1"><span>24.6.10 Parser-based Font Lock<a class="copiable-link" href="#Parser_002dbased-Font-Lock-1"> &para;</a></span></h4>
<a class="index-entry-id" id="index-parser_002dbased-font_002dlock"></a>


<p>Besides simple syntactic font lock and regexp-based font lock, Emacs
also provides complete syntactic font lock with the help of a parser.
Currently, Emacs uses the tree-sitter library (see <a class="pxref" href="Parsing-Program-Source.html">Parsing Program Source</a>) for this purpose.
</p>
<p>Parser-based font lock and other font lock mechanisms are not mutually
exclusive.  By default, if enabled, parser-based font lock runs first,
replacing syntactic font lock, followed by regexp-based font lock.
</p>
<p>Although parser-based font lock doesn&rsquo;t share the same customization
variables with regexp-based font lock, it uses similar customization
schemes.  The tree-sitter counterpart of <code class="code">font-lock-keywords</code> is
<code class="code">treesit-font-lock-settings</code>.
</p>
<a class="index-entry-id" id="index-tree_002dsitter-fontifications_002c-overview"></a>
<a class="index-entry-id" id="index-fontifications-with-tree_002dsitter_002c-overview"></a>
<p>In general, tree-sitter fontification works as follows:
</p>
<ul class="itemize mark-bullet">
<li>A Lisp program (usually, part of a major mode) provides a <em class="dfn">query</em>
consisting of <em class="dfn">patterns</em>, each pattern associated with a
<em class="dfn">capture name</em>.

</li><li>The tree-sitter library finds the nodes in the parse tree
that match these patterns, tags the nodes with the corresponding
capture names, and returns them to the Lisp program.

</li><li>The Lisp program uses the returned nodes to highlight the portions of
buffer text corresponding to each node as appropriate, using the
tagged capture names of the nodes to determine the correct
fontification.  For example, a node tagged <code class="code">font-lock-keyword</code>
would be highlighted in <code class="code">font-lock-keyword</code> face.
</li></ul>

<p>For more information about queries, patterns, and capture names, see
<a class="ref" href="Pattern-Matching.html">Pattern Matching Tree-sitter Nodes</a>.
</p>
<p>To set up tree-sitter fontification, a major mode should first set
<code class="code">treesit-font-lock-settings</code> with the output of
<code class="code">treesit-font-lock-rules</code>, then call
<code class="code">treesit-major-mode-setup</code>.
</p>
<dl class="first-deffn first-defun-alias-first-deffn">
<dt class="deffn defun-alias-deffn" id="index-treesit_002dfont_002dlock_002drules"><span class="category-def">Function: </span><span><strong class="def-name">treesit-font-lock-rules</strong> <var class="def-var-arguments">&amp;rest query-specs</var><a class="copiable-link" href="#index-treesit_002dfont_002dlock_002drules"> &para;</a></span></dt>
<dd><p>This function is used to set <code class="code">treesit-font-lock-settings</code>.  It
takes care of compiling queries and other post-processing, and outputs
a value that <code class="code">treesit-font-lock-settings</code> accepts.  Here&rsquo;s an
example:
</p>
<div class="example">
<div class="group"><pre class="example-preformatted">(treesit-font-lock-rules
 :language 'javascript
 :feature 'constant
 :override t
 '((true) @font-lock-constant-face
   (false) @font-lock-constant-face)
 :language 'html
 :feature 'script
 &quot;(script_element) @font-lock-builtin-face&quot;)
</pre></div></div>

<p>This function takes a series of <var class="var">query-spec</var>s, where each
<var class="var">query-spec</var> is a <var class="var">query</var> preceded by one or more
<var class="var">keyword</var>/<var class="var">value</var> pairs.  Each <var class="var">query</var> is a tree-sitter
query in either the string, s-expression, or compiled form.
</p>
<p>For each <var class="var">query</var>, the <var class="var">keyword</var>/<var class="var">value</var> pairs that precede
it add meta information to it.  The <code class="code">:language</code> keyword declares
<var class="var">query</var>&rsquo;s language.  The <code class="code">:feature</code> keyword sets the feature
name of <var class="var">query</var>.  Users can control which features are enabled
with <code class="code">treesit-font-lock-level</code> and
<code class="code">treesit-font-lock-feature-list</code> (described below).  These two
keywords are mandatory.
</p>
<p>Other keywords are optional:
</p>
<table class="multitable">
<thead><tr><th width="15%">Keyword</th><th width="15%">Value</th><th width="60%">Description</th></tr></thead>
<tbody><tr><td width="15%"><code class="code">:override</code></td><td width="15%"><code class="code">nil</code></td><td width="60%">If the region already has a face, discard the new face</td></tr>
<tr><td width="15%"></td><td width="15%"><code class="code">t</code></td><td width="60%">Always apply the new face</td></tr>
<tr><td width="15%"></td><td width="15%"><code class="code">append</code></td><td width="60%">Append the new face to existing ones</td></tr>
<tr><td width="15%"></td><td width="15%"><code class="code">prepend</code></td><td width="60%">Prepend the new face to existing ones</td></tr>
<tr><td width="15%"></td><td width="15%"><code class="code">keep</code></td><td width="60%">Fill-in regions without an existing face</td></tr>
</tbody>
</table>

<p>Lisp programs mark patterns in <var class="var">query</var> with capture names (names
that start with <code class="code">@</code>), and tree-sitter will return matched nodes
tagged with those same capture names.  For the purpose of
fontification, capture names in <var class="var">query</var> should be face names like
<code class="code">font-lock-keyword-face</code>.  The captured node will be fontified
with that face.
</p>
<a class="index-entry-id" id="index-treesit_002dfontify_002dwith_002doverride"></a>
<p>A capture name can also be a function name, in which case the function
is called with 4 arguments: <var class="var">node</var> and <var class="var">override</var>, <var class="var">start</var>
and <var class="var">end</var>, where <var class="var">node</var> is the node itself, <var class="var">override</var> is
the <code class="code">:override</code> property of the rule which captured this node,
and <var class="var">start</var> and <var class="var">end</var> limit the region which this function
should fontify.  (If this function wants to respect the <var class="var">override</var>
argument, it can use <code class="code">treesit-fontify-with-override</code>.)
</p>
<p>Beyond the 4 arguments presented, this function should accept more
arguments as optional arguments for future extensibility.
</p>
<p>If a capture name is both a face and a function, the face takes
priority.  If a capture name is neither a face nor a function, it is
ignored.
</p></dd></dl>

<dl class="first-defvr first-defvar-alias-first-defvr">
<dt class="defvr defvar-alias-defvr" id="index-treesit_002dfont_002dlock_002dfeature_002dlist"><span class="category-def">Variable: </span><span><strong class="def-name">treesit-font-lock-feature-list</strong><a class="copiable-link" href="#index-treesit_002dfont_002dlock_002dfeature_002dlist"> &para;</a></span></dt>
<dd><p>This is a list of lists of feature symbols.  Each element of the list
is a list that represents a decoration level.
<code class="code">treesit-font-lock-level</code> controls which levels are
activated.
</p>
<p>Each element of the list is a list of the form <code class="code">(<var class="var">feature</var>&nbsp;&hellip;)</code><!-- /@w -->, where each <var class="var">feature</var> corresponds to the
<code class="code">:feature</code> value of a query defined in
<code class="code">treesit-font-lock-rules</code>.  Removing a feature symbol from this
list disables the corresponding query during font-lock.
</p>
<p>Common feature names, for many programming languages, include
<code class="code">definition</code>, <code class="code">type</code>, <code class="code">assignment</code>, <code class="code">builtin</code>,
<code class="code">constant</code>, <code class="code">keyword</code>, <code class="code">string-interpolation</code>,
<code class="code">comment</code>, <code class="code">doc</code>, <code class="code">string</code>, <code class="code">operator</code>,
<code class="code">preprocessor</code>, <code class="code">escape-sequence</code>, and <code class="code">key</code>.  Major
modes are free to subdivide or extend these common features.
</p>
<p>Some of these features warrant some explanation: <code class="code">definition</code>
highlights whatever is being defined, e.g., the function name in a
function definition, the struct name in a struct definition, the
variable name in a variable definition; <code class="code">assignment</code> highlights
whatever is being assigned to, e.g., the variable or field in an
assignment statement; <code class="code">key</code> highlights keys in key-value pairs,
e.g., keys in a JSON object or Python dictionary; <code class="code">doc</code>
highlights docstrings or doc-comments.
</p>
<p>For example, the value of this variable could be:
</p><div class="example">
<div class="group"><pre class="example-preformatted">((comment string doc) ; level 1
 (function-name keyword type builtin constant) ; level 2
 (variable-name string-interpolation key)) ; level 3
</pre></div></div>

<p>Major modes should set this variable before calling
<code class="code">treesit-major-mode-setup</code>.
</p>
<a class="index-entry-id" id="index-treesit_002dfont_002dlock_002drecompute_002dfeatures"></a>
<p>For this variable to take effect, a Lisp program should call
<code class="code">treesit-font-lock-recompute-features</code> (which resets
<code class="code">treesit-font-lock-settings</code> accordingly), or
<code class="code">treesit-major-mode-setup</code> (which calls
<code class="code">treesit-font-lock-recompute-features</code>).
</p></dd></dl>

<dl class="first-defvr first-defvar-alias-first-defvr">
<dt class="defvr defvar-alias-defvr" id="index-treesit_002dfont_002dlock_002dsettings"><span class="category-def">Variable: </span><span><strong class="def-name">treesit-font-lock-settings</strong><a class="copiable-link" href="#index-treesit_002dfont_002dlock_002dsettings"> &para;</a></span></dt>
<dd><p>A list of settings for tree-sitter based font lock.  The exact format
of each setting is considered internal.  One should always use
<code class="code">treesit-font-lock-rules</code> to set this variable.
</p>
</dd></dl>

<p>Multi-language major modes should provide range functions in
<code class="code">treesit-range-functions</code>, and Emacs will set the ranges
accordingly before fontifing a region (see <a class="pxref" href="Multiple-Languages.html">Parsing Text in Multiple Languages</a>).
</p>
</div>
<hr>
<div class="nav-panel">
<p>
Previous: <a href="Multiline-Font-Lock.html">Multiline Font Lock Constructs</a>, Up: <a href="Font-Lock-Mode.html">Font Lock Mode</a> &nbsp; [<a href="index.html#SEC_Contents" title="Table of contents" rel="contents">Contents</a>][<a href="Index.html" title="Index" rel="index">Index</a>]</p>
</div>



</body>
</html>
