<!DOCTYPE html>
<html>
<!-- Created by GNU Texinfo 7.1, https://www.gnu.org/software/texinfo/ -->
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<!-- This is the GNU Emacs Lisp Reference Manual
corresponding to Emacs version 29.1.

Copyright Â© 1990-1996, 1998-2023 Free Software Foundation,
Inc.

Permission is granted to copy, distribute and/or modify this document
under the terms of the GNU Free Documentation License, Version 1.3 or
any later version published by the Free Software Foundation; with the
Invariant Sections being "GNU General Public License," with the
Front-Cover Texts being "A GNU Manual," and with the Back-Cover
Texts as in (a) below.  A copy of the license is included in the
section entitled "GNU Free Documentation License."

(a) The FSF's Back-Cover Text is: "You have the freedom to copy and
modify this GNU manual.  Buying copies from the FSF supports it in
developing GNU and promoting software freedom." -->
<title>Multiple Languages (GNU Emacs Lisp Reference Manual)</title>

<meta name="description" content="Multiple Languages (GNU Emacs Lisp Reference Manual)">
<meta name="keywords" content="Multiple Languages (GNU Emacs Lisp Reference Manual)">
<meta name="resource-type" content="document">
<meta name="distribution" content="global">
<meta name="Generator" content="makeinfo">
<meta name="viewport" content="width=device-width,initial-scale=1">

<link href="index.html" rel="start" title="Top">
<link href="Index.html" rel="index" title="Index">
<link href="index.html#SEC_Contents" rel="contents" title="Table of Contents">
<link href="Parsing-Program-Source.html" rel="up" title="Parsing Program Source">
<link href="Tree_002dsitter-Major-Modes.html" rel="next" title="Tree-sitter Major Modes">
<link href="Pattern-Matching.html" rel="prev" title="Pattern Matching">
<style type="text/css">
<!--
a.copiable-link {visibility: hidden; text-decoration: none; line-height: 0em}
div.example {margin-left: 3.2em}
span:hover a.copiable-link {visibility: visible}
strong.def-name {font-family: monospace; font-weight: bold; font-size: larger}
-->
</style>
<link rel="stylesheet" type="text/css" href="./manual.css">


</head>

<body lang="en">
<div class="section-level-extent" id="Multiple-Languages">
<div class="nav-panel">
<p>
Next: <a href="Tree_002dsitter-Major-Modes.html" accesskey="n" rel="next">Developing major modes with tree-sitter</a>, Previous: <a href="Pattern-Matching.html" accesskey="p" rel="prev">Pattern Matching Tree-sitter Nodes</a>, Up: <a href="Parsing-Program-Source.html" accesskey="u" rel="up">Parsing Program Source</a> &nbsp; [<a href="index.html#SEC_Contents" title="Table of contents" rel="contents">Contents</a>][<a href="Index.html" title="Index" rel="index">Index</a>]</p>
</div>
<hr>
<h3 class="section" id="Parsing-Text-in-Multiple-Languages"><span>37.6 Parsing Text in Multiple Languages<a class="copiable-link" href="#Parsing-Text-in-Multiple-Languages"> &para;</a></span></h3>
<a class="index-entry-id" id="index-multiple-languages_002c-parsing-with-tree_002dsitter"></a>
<a class="index-entry-id" id="index-parsing-multiple-languages-with-tree_002dsitter"></a>
<p>Sometimes, the source of a programming language could contain snippets
of other languages; <abbr class="acronym">HTML</abbr> + <abbr class="acronym">CSS</abbr> + JavaScript is one
example.  In that case, text segments written in different languages
need to be assigned different parsers.  Traditionally, this is
achieved by using narrowing.  While tree-sitter works with narrowing
(see <a class="pxref" href="Using-Parser.html#tree_002dsitter-narrowing">narrowing</a>), the recommended way is
instead to specify regions of buffer text (i.e., ranges) in which a
parser will operate.  This section describes functions for setting and
getting ranges for a parser.
</p>
<p>Lisp programs should call <code class="code">treesit-update-ranges</code> to make sure
the ranges for each parser are correct before using parsers in a
buffer, and call <code class="code">treesit-language-at</code> to figure out the language
responsible for the text at some position.  These two functions don&rsquo;t
work by themselves, they need major modes to set
<code class="code">treesit-range-settings</code> and
<code class="code">treesit-language-at-point-function</code>, which do the actual work.
These functions and variables are explained in more detail towards the
end of the section.
</p>
<h3 class="heading" id="Getting-and-setting-ranges"><span>Getting and setting ranges<a class="copiable-link" href="#Getting-and-setting-ranges"> &para;</a></span></h3>

<dl class="first-deffn first-defun-alias-first-deffn">
<dt class="deffn defun-alias-deffn" id="index-treesit_002dparser_002dset_002dincluded_002dranges"><span class="category-def">Function: </span><span><strong class="def-name">treesit-parser-set-included-ranges</strong> <var class="def-var-arguments">parser ranges</var><a class="copiable-link" href="#index-treesit_002dparser_002dset_002dincluded_002dranges"> &para;</a></span></dt>
<dd><p>This function sets up <var class="var">parser</var> to operate on <var class="var">ranges</var>.  The
<var class="var">parser</var> will only read the text of the specified ranges.  Each
range in <var class="var">ranges</var> is a pair of the form <code class="code">(<var class="var">beg</var>&nbsp;.&nbsp;<var class="var">end</var>)</code><!-- /@w -->.
</p>
<p>The ranges in <var class="var">ranges</var> must come in order and must not overlap.
That is, in pseudo code:
</p>
<div class="example">
<div class="group"><pre class="example-preformatted">(cl-loop for idx from 1 to (1- (length ranges))
         for prev = (nth (1- idx) ranges)
         for next = (nth idx ranges)
         should (&lt;= (car prev) (cdr prev)
                    (car next) (cdr next)))
</pre></div></div>

<a class="index-entry-id" id="index-treesit_002drange_002dinvalid"></a>
<p>If <var class="var">ranges</var> violates this constraint, or something else went
wrong, this function signals the <code class="code">treesit-range-invalid</code> error.
The signal data contains a specific error message and the ranges we
are trying to set.
</p>
<p>This function can also be used for disabling ranges.  If <var class="var">ranges</var>
is <code class="code">nil</code>, the parser is set to parse the whole buffer.
</p>
<p>Example:
</p>
<div class="example">
<div class="group"><pre class="example-preformatted">(treesit-parser-set-included-ranges
 parser '((1 . 9) (16 . 24) (24 . 25)))
</pre></div></div>
</dd></dl>

<dl class="first-deffn first-defun-alias-first-deffn">
<dt class="deffn defun-alias-deffn" id="index-treesit_002dparser_002dincluded_002dranges"><span class="category-def">Function: </span><span><strong class="def-name">treesit-parser-included-ranges</strong> <var class="def-var-arguments">parser</var><a class="copiable-link" href="#index-treesit_002dparser_002dincluded_002dranges"> &para;</a></span></dt>
<dd><p>This function returns the ranges set for <var class="var">parser</var>.  The return
value is the same as the <var class="var">ranges</var> argument of
<code class="code">treesit-parser-included-ranges</code>: a list of cons cells of the form
<code class="code">(<var class="var">beg</var>&nbsp;.&nbsp;<var class="var">end</var>)</code><!-- /@w -->.  If <var class="var">parser</var> doesn&rsquo;t have any
ranges, the return value is <code class="code">nil</code>.
</p>
<div class="example">
<div class="group"><pre class="example-preformatted">(treesit-parser-included-ranges parser)
    &rArr; ((1 . 9) (16 . 24) (24 . 25))
</pre></div></div>
</dd></dl>

<dl class="first-deffn first-defun-alias-first-deffn">
<dt class="deffn defun-alias-deffn" id="index-treesit_002dquery_002drange"><span class="category-def">Function: </span><span><strong class="def-name">treesit-query-range</strong> <var class="def-var-arguments">source query &amp;optional beg end</var><a class="copiable-link" href="#index-treesit_002dquery_002drange"> &para;</a></span></dt>
<dd><p>This function matches <var class="var">source</var> with <var class="var">query</var> and returns the
ranges of captured nodes.  The return value is a list of cons cells of
the form <code class="code">(<var class="var">beg</var>&nbsp;.&nbsp;<var class="var">end</var>)</code><!-- /@w -->, where <var class="var">beg</var> and
<var class="var">end</var> specify the beginning and the end of a region of text.
</p>
<p>For convenience, <var class="var">source</var> can be a language symbol, a parser, or a
node.  If it&rsquo;s a language symbol, this function matches in the root
node of the first parser using that language; if a parser, this
function matches in the root node of that parser; if a node, this
function matches in that node.
</p>
<p>The argument <var class="var">query</var> is the query used to capture nodes
(see <a class="pxref" href="Pattern-Matching.html">Pattern Matching Tree-sitter Nodes</a>).  The capture names don&rsquo;t matter.  The
arguments <var class="var">beg</var> and <var class="var">end</var>, if both non-<code class="code">nil</code>, limit the
range in which this function queries.
</p>
<p>Like other query functions, this function raises the
<code class="code">treesit-query-error</code> error if <var class="var">query</var> is malformed.
</p></dd></dl>

<h3 class="heading" id="Supporting-multiple-languages-in-Lisp-programs"><span>Supporting multiple languages in Lisp programs<a class="copiable-link" href="#Supporting-multiple-languages-in-Lisp-programs"> &para;</a></span></h3>

<p>It should suffice for general Lisp programs to call the following two
functions in order to support program sources that mix multiple
languages.
</p>
<dl class="first-deffn first-defun-alias-first-deffn">
<dt class="deffn defun-alias-deffn" id="index-treesit_002dupdate_002dranges"><span class="category-def">Function: </span><span><strong class="def-name">treesit-update-ranges</strong> <var class="def-var-arguments">&amp;optional beg end</var><a class="copiable-link" href="#index-treesit_002dupdate_002dranges"> &para;</a></span></dt>
<dd><p>This function updates ranges for parsers in the buffer.  It makes sure
the parsers&rsquo; ranges are set correctly between <var class="var">beg</var> and <var class="var">end</var>,
according to <code class="code">treesit-range-settings</code>.  If omitted, <var class="var">beg</var>
defaults to the beginning of the buffer, and <var class="var">end</var> defaults to the
end of the buffer.
</p>
<p>For example, fontification functions use this function before querying
for nodes in a region.
</p></dd></dl>

<dl class="first-deffn first-defun-alias-first-deffn">
<dt class="deffn defun-alias-deffn" id="index-treesit_002dlanguage_002dat"><span class="category-def">Function: </span><span><strong class="def-name">treesit-language-at</strong> <var class="def-var-arguments">pos</var><a class="copiable-link" href="#index-treesit_002dlanguage_002dat"> &para;</a></span></dt>
<dd><p>This function returns the language of the text at buffer position
<var class="var">pos</var>.  Under the hood it calls
<code class="code">treesit-language-at-point-function</code> and returns its return
value.  If <code class="code">treesit-language-at-point-function</code> is <code class="code">nil</code>,
this function returns the language of the first parser in the returned
value of <code class="code">treesit-parser-list</code>.  If there is no parser in the
buffer, it returns <code class="code">nil</code>.
</p></dd></dl>

<h3 class="heading" id="Supporting-multiple-languages-in-major-modes"><span>Supporting multiple languages in major modes<a class="copiable-link" href="#Supporting-multiple-languages-in-major-modes"> &para;</a></span></h3>

<a class="index-entry-id" id="index-host-language_002c-tree_002dsitter"></a>
<a class="index-entry-id" id="index-tree_002dsitter-host-and-embedded-languages"></a>
<a class="index-entry-id" id="index-embedded-language_002c-tree_002dsitter"></a>
<p>Normally, in a set of languages that can be mixed together, there is a
<em class="dfn">host language</em> and one or more <em class="dfn">embedded languages</em>.  A Lisp
program usually first parses the whole document with the host
language&rsquo;s parser, retrieves some information, sets ranges for the
embedded languages with that information, and then parses the embedded
languages.
</p>
<p>Take a buffer containing <abbr class="acronym">HTML</abbr>, <abbr class="acronym">CSS</abbr>, and JavaScript
as an example.  A Lisp program will first parse the whole buffer with
an <abbr class="acronym">HTML</abbr> parser, then query the parser for
<code class="code">style_element</code> and <code class="code">script_element</code> nodes, which correspond
to <abbr class="acronym">CSS</abbr> and JavaScript text, respectively.  Then it sets the
range of the <abbr class="acronym">CSS</abbr> and JavaScript parsers to the range which
their corresponding nodes span.
</p>
<p>Given a simple <abbr class="acronym">HTML</abbr> document:
</p>
<div class="example">
<div class="group"><pre class="example-preformatted">&lt;html&gt;
  &lt;script&gt;1 + 2&lt;/script&gt;
  &lt;style&gt;body { color: &quot;blue&quot;; }&lt;/style&gt;
&lt;/html&gt;
</pre></div></div>

<p>a Lisp program will first parse with a <abbr class="acronym">HTML</abbr> parser, then set
ranges for <abbr class="acronym">CSS</abbr> and JavaScript parsers:
</p>
<div class="example">
<div class="group"><pre class="example-preformatted">;; Create parsers.
(setq html (treesit-parser-create 'html))
(setq css (treesit-parser-create 'css))
(setq js (treesit-parser-create 'javascript))
</pre></div><pre class="example-preformatted">

</pre><div class="group"><pre class="example-preformatted">;; Set CSS ranges.
(setq css-range
      (treesit-query-range
       'html
       '((style_element (raw_text) @capture))))
(treesit-parser-set-included-ranges css css-range)
</pre></div><pre class="example-preformatted">

</pre><div class="group"><pre class="example-preformatted">;; Set JavaScript ranges.
(setq js-range
      (treesit-query-range
       'html
       '((script_element (raw_text) @capture))))
(treesit-parser-set-included-ranges js js-range)
</pre></div></div>

<p>Emacs automates this process in <code class="code">treesit-update-ranges</code>.  A
multi-language major mode should set <code class="code">treesit-range-settings</code> so
that <code class="code">treesit-update-ranges</code> knows how to perform this process
automatically.  Major modes should use the helper function
<code class="code">treesit-range-rules</code> to generate a value that can be assigned to
<code class="code">treesit-range-settings</code>.  The settings in the following example
directly translate into operations shown above.
</p>
<div class="example">
<div class="group"><pre class="example-preformatted">(setq treesit-range-settings
      (treesit-range-rules
       :embed 'javascript
       :host 'html
       '((script_element (raw_text) @capture))
</pre></div><pre class="example-preformatted">

</pre><div class="group"><pre class="example-preformatted">       :embed 'css
       :host 'html
       '((style_element (raw_text) @capture))))
</pre></div></div>

<dl class="first-deffn first-defun-alias-first-deffn">
<dt class="deffn defun-alias-deffn" id="index-treesit_002drange_002drules"><span class="category-def">Function: </span><span><strong class="def-name">treesit-range-rules</strong> <var class="def-var-arguments">&amp;rest query-specs</var><a class="copiable-link" href="#index-treesit_002drange_002drules"> &para;</a></span></dt>
<dd><p>This function is used to set <code class="code">treesit-range-settings</code>.  It takes
care of compiling queries and other post-processing, and outputs a
value that <code class="code">treesit-range-settings</code> can have.
</p>
<p>It takes a series of <var class="var">query-spec</var>s, where each <var class="var">query-spec</var> is
a <var class="var">query</var> preceded by zero or more <var class="var">keyword</var>/<var class="var">value</var>
pairs.  Each <var class="var">query</var> is a tree-sitter query in either the string,
s-expression, or compiled form, or a function.
</p>
<p>If <var class="var">query</var> is a tree-sitter query, it should be preceded by two
<var class="var">keyword</var>/<var class="var">value</var> pairs, where the <code class="code">:embed</code> keyword
specifies the embedded language, and the <code class="code">:host</code> keyword
specifies the host language.
</p>
<p><code class="code">treesit-update-ranges</code> uses <var class="var">query</var> to figure out how to set
the ranges for parsers for the embedded language.  It queries
<var class="var">query</var> in a host language parser, computes the ranges which the
captured nodes span, and applies these ranges to embedded language
parsers.
</p>
<p>If <var class="var">query</var> is a function, it doesn&rsquo;t need any <var class="var">keyword</var> and
<var class="var">value</var> pair.  It should be a function that takes 2 arguments,
<var class="var">start</var> and <var class="var">end</var>, and sets the ranges for parsers in the
current buffer in the region between <var class="var">start</var> and <var class="var">end</var>.  It is
fine for this function to set ranges in a larger region that
encompasses the region between <var class="var">start</var> and <var class="var">end</var>.
</p></dd></dl>

<dl class="first-defvr first-defvar-alias-first-defvr">
<dt class="defvr defvar-alias-defvr" id="index-treesit_002drange_002dsettings"><span class="category-def">Variable: </span><span><strong class="def-name">treesit-range-settings</strong><a class="copiable-link" href="#index-treesit_002drange_002dsettings"> &para;</a></span></dt>
<dd><p>This variable helps <code class="code">treesit-update-ranges</code> in updating the
ranges for parsers in the buffer.  It is a list of <var class="var">setting</var>s
where the exact format of a <var class="var">setting</var> is considered internal.  You
should use <code class="code">treesit-range-rules</code> to generate a value that this
variable can have.
</p>
</dd></dl>


<dl class="first-defvr first-defvar-alias-first-defvr">
<dt class="defvr defvar-alias-defvr" id="index-treesit_002dlanguage_002dat_002dpoint_002dfunction"><span class="category-def">Variable: </span><span><strong class="def-name">treesit-language-at-point-function</strong><a class="copiable-link" href="#index-treesit_002dlanguage_002dat_002dpoint_002dfunction"> &para;</a></span></dt>
<dd><p>This variable&rsquo;s value should be a function that takes a single
argument, <var class="var">pos</var>, which is a buffer position, and returns the
language of the buffer text at <var class="var">pos</var>.  This variable is used by
<code class="code">treesit-language-at</code>.
</p></dd></dl>

</div>
<hr>
<div class="nav-panel">
<p>
Next: <a href="Tree_002dsitter-Major-Modes.html">Developing major modes with tree-sitter</a>, Previous: <a href="Pattern-Matching.html">Pattern Matching Tree-sitter Nodes</a>, Up: <a href="Parsing-Program-Source.html">Parsing Program Source</a> &nbsp; [<a href="index.html#SEC_Contents" title="Table of contents" rel="contents">Contents</a>][<a href="Index.html" title="Index" rel="index">Index</a>]</p>
</div>



</body>
</html>
