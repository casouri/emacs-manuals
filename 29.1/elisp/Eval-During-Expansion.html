<!DOCTYPE html>
<html>
<!-- Created by GNU Texinfo 7.1, https://www.gnu.org/software/texinfo/ -->
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<!-- This is the GNU Emacs Lisp Reference Manual
corresponding to Emacs version 29.1.

Copyright Â© 1990-1996, 1998-2023 Free Software Foundation,
Inc.

Permission is granted to copy, distribute and/or modify this document
under the terms of the GNU Free Documentation License, Version 1.3 or
any later version published by the Free Software Foundation; with the
Invariant Sections being "GNU General Public License," with the
Front-Cover Texts being "A GNU Manual," and with the Back-Cover
Texts as in (a) below.  A copy of the license is included in the
section entitled "GNU Free Documentation License."

(a) The FSF's Back-Cover Text is: "You have the freedom to copy and
modify this GNU manual.  Buying copies from the FSF supports it in
developing GNU and promoting software freedom." -->
<title>Eval During Expansion (GNU Emacs Lisp Reference Manual)</title>

<meta name="description" content="Eval During Expansion (GNU Emacs Lisp Reference Manual)">
<meta name="keywords" content="Eval During Expansion (GNU Emacs Lisp Reference Manual)">
<meta name="resource-type" content="document">
<meta name="distribution" content="global">
<meta name="Generator" content="makeinfo">
<meta name="viewport" content="width=device-width,initial-scale=1">

<link href="index.html" rel="start" title="Top">
<link href="Index.html" rel="index" title="Index">
<link href="index.html#SEC_Contents" rel="contents" title="Table of Contents">
<link href="Problems-with-Macros.html" rel="up" title="Problems with Macros">
<link href="Repeated-Expansion.html" rel="next" title="Repeated Expansion">
<link href="Surprising-Local-Vars.html" rel="prev" title="Surprising Local Vars">
<style type="text/css">
<!--
a.copiable-link {visibility: hidden; text-decoration: none; line-height: 0em}
div.example {margin-left: 3.2em}
span.r {font-family: initial; font-weight: normal; font-style: normal}
span:hover a.copiable-link {visibility: visible}
-->
</style>
<link rel="stylesheet" type="text/css" href="./manual.css">


</head>

<body lang="en">
<div class="subsection-level-extent" id="Eval-During-Expansion">
<div class="nav-panel">
<p>
Next: <a href="Repeated-Expansion.html" accesskey="n" rel="next">How Many Times is the Macro Expanded?</a>, Previous: <a href="Surprising-Local-Vars.html" accesskey="p" rel="prev">Local Variables in Macro Expansions</a>, Up: <a href="Problems-with-Macros.html" accesskey="u" rel="up">Common Problems Using Macros</a> &nbsp; [<a href="index.html#SEC_Contents" title="Table of contents" rel="contents">Contents</a>][<a href="Index.html" title="Index" rel="index">Index</a>]</p>
</div>
<hr>
<h4 class="subsection" id="Evaluating-Macro-Arguments-in-Expansion"><span>14.5.4 Evaluating Macro Arguments in Expansion<a class="copiable-link" href="#Evaluating-Macro-Arguments-in-Expansion"> &para;</a></span></h4>

<p>Another problem can happen if the macro definition itself
evaluates any of the macro argument expressions, such as by calling
<code class="code">eval</code> (see <a class="pxref" href="Eval.html">Eval</a>).  You have to take into account that macro
expansion may take place long before the code is executed, when the
context of the caller (where the macro expansion will be evaluated) is
not yet accessible.
</p>
<p>Also, if your macro definition does not use <code class="code">lexical-binding</code>, its
formal arguments may hide the user&rsquo;s variables of the same name.  Inside
the macro body, the macro argument binding is the most local binding of
such variable, so any references inside the form being evaluated do refer
to it.  Here is an example:
</p>
<div class="example">
<div class="group"><pre class="example-preformatted">(defmacro foo (a)
  (list 'setq (eval a) t))
</pre></div><div class="group"><pre class="example-preformatted">(setq x 'b)
(foo x) &rarr; (setq b t)
     &rArr; t                  ; <span class="r">and <code class="code">b</code> has been set.</span>
;; <span class="r">but</span>
(setq a 'c)
(foo a) &rarr; (setq a t)
     &rArr; t                  ; <span class="r">but this set <code class="code">a</code>, not <code class="code">c</code>.</span>

</pre></div></div>

<p>It makes a difference whether the user&rsquo;s variable is named <code class="code">a</code> or
<code class="code">x</code>, because <code class="code">a</code> conflicts with the macro argument variable
<code class="code">a</code>.
</p>
<p>Also, the expansion of <code class="code">(foo x)</code> above will return something
different or signal an error when the code is compiled, since in that case
<code class="code">(foo x)</code> is expanded during compilation, whereas the execution of
<code class="code">(setq x 'b)</code> will only take place later when the code is executed.
</p>
<p>To avoid these problems, <strong class="strong">don&rsquo;t evaluate an argument expression
while computing the macro expansion</strong>.  Instead, substitute the
expression into the macro expansion, so that its value will be computed
as part of executing the expansion.  This is how the other examples in
this chapter work.
</p>
</div>
<hr>
<div class="nav-panel">
<p>
Next: <a href="Repeated-Expansion.html">How Many Times is the Macro Expanded?</a>, Previous: <a href="Surprising-Local-Vars.html">Local Variables in Macro Expansions</a>, Up: <a href="Problems-with-Macros.html">Common Problems Using Macros</a> &nbsp; [<a href="index.html#SEC_Contents" title="Table of contents" rel="contents">Contents</a>][<a href="Index.html" title="Index" rel="index">Index</a>]</p>
</div>



</body>
</html>
