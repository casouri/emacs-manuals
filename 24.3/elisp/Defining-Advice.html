<!DOCTYPE html>
<html>
<!-- Created by GNU Texinfo 7.1, https://www.gnu.org/software/texinfo/ -->
<head>
<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
<!-- This is the GNU Emacs Lisp Reference Manual
corresponding to Emacs version 24.3.

Copyright © 1990-1996, 1998-2013 Free Software Foundation, Inc.

Permission is granted to copy, distribute and/or modify this document
under the terms of the GNU Free Documentation License, Version 1.3 or
any later version published by the Free Software Foundation; with the
Invariant Sections being "GNU General Public License," with the
Front-Cover texts being "A GNU Manual," and with the Back-Cover
Texts as in (a) below.  A copy of the license is included in the
section entitled "GNU Free Documentation License."

(a) The FSF's Back-Cover Text is: "You have the freedom to copy and
modify this GNU manual.  Buying copies from the FSF supports it in
developing GNU and promoting software freedom." -->
<title>Defining Advice (GNU Emacs Lisp Reference Manual)</title>

<meta name="description" content="Defining Advice (GNU Emacs Lisp Reference Manual)">
<meta name="keywords" content="Defining Advice (GNU Emacs Lisp Reference Manual)">
<meta name="resource-type" content="document">
<meta name="distribution" content="global">
<meta name="Generator" content="makeinfo">
<meta name="viewport" content="width=device-width,initial-scale=1">

<link href="index.html" rel="start" title="Top">
<link href="Index.html" rel="index" title="Index">
<link href="index.html#SEC_Contents" rel="contents" title="Table of Contents">
<link href="Advising-Functions.html" rel="up" title="Advising Functions">
<link href="Around_002dAdvice.html" rel="next" title="Around-Advice">
<link href="Simple-Advice.html" rel="prev" title="Simple Advice">
<style type="text/css">
<!--
a.copiable-link {visibility: hidden; text-decoration: none; line-height: 0em}
div.example {margin-left: 3.2em}
span.r {font-family: initial; font-weight: normal; font-style: normal}
span:hover a.copiable-link {visibility: visible}
strong.def-name {font-family: monospace; font-weight: bold; font-size: larger}
-->
</style>


</head>

<body lang="en">
<div class="section-level-extent" id="Defining-Advice">
<div class="nav-panel">
<p>
Next: <a href="Around_002dAdvice.html" accesskey="n" rel="next">Around-Advice</a>, Previous: <a href="Simple-Advice.html" accesskey="p" rel="prev">A Simple Advice Example</a>, Up: <a href="Advising-Functions.html" accesskey="u" rel="up">Advising Emacs Lisp Functions</a> &nbsp; [<a href="index.html#SEC_Contents" title="Table of contents" rel="contents">Contents</a>][<a href="Index.html" title="Index" rel="index">Index</a>]</p>
</div>
<hr>
<h3 class="section" id="Defining-Advice-1"><span>17.2 Defining Advice<a class="copiable-link" href="#Defining-Advice-1"> &para;</a></span></h3>
<a class="index-entry-id" id="index-defining-advice"></a>
<a class="index-entry-id" id="index-advice_002c-defining"></a>

<p>To define a piece of advice, use the macro <code class="code">defadvice</code>.  A call
to <code class="code">defadvice</code> has the following syntax, which is based on the
syntax of <code class="code">defun</code> and <code class="code">defmacro</code>, but adds more:
</p>
<a class="index-entry-id" id="index-defadvice"></a>
<div class="example">
<pre class="example-preformatted">(defadvice <var class="var">function</var> (<var class="var">class</var> <var class="var">name</var>
                         <span class="r">[</span><var class="var">position</var><span class="r">]</span> <span class="r">[</span><var class="var">arglist</var><span class="r">]</span>
                         <var class="var">flags</var>...)
  <span class="r">[</span><var class="var">documentation-string</var><span class="r">]</span>
  <span class="r">[</span><var class="var">interactive-form</var><span class="r">]</span>
  <var class="var">body-forms</var>...)
</pre></div>

<p>Here, <var class="var">function</var> is the name of the function (or macro or special
form) to be advised.  From now on, we will write just &ldquo;function&rdquo; when
describing the entity being advised, but this always includes macros and
special forms.
</p>
<p>In place of the argument list in an ordinary definition, an advice
definition calls for several different pieces of information.
</p>
<a class="index-entry-id" id="index-class-of-advice"></a>
<a class="index-entry-id" id="index-before_002dadvice"></a>
<a class="index-entry-id" id="index-after_002dadvice"></a>
<a class="index-entry-id" id="index-around_002dadvice"></a>
<p><var class="var">class</var> specifies the <em class="dfn">class</em> of the advice&mdash;one of <code class="code">before</code>,
<code class="code">after</code>, or <code class="code">around</code>.  Before-advice runs before the function
itself; after-advice runs after the function itself; around-advice is
wrapped around the execution of the function itself.  After-advice and
around-advice can override the return value by setting
<code class="code">ad-return-value</code>.
</p>
<dl class="first-defvr first-defvar-alias-first-defvr">
<dt class="defvr defvar-alias-defvr" id="index-ad_002dreturn_002dvalue"><span class="category-def">Variable: </span><span><strong class="def-name">ad-return-value</strong><a class="copiable-link" href="#index-ad_002dreturn_002dvalue"> &para;</a></span></dt>
<dd><p>While advice is executing, after the function&rsquo;s original definition has
been executed, this variable holds its return value, which will
ultimately be returned to the caller after finishing all the advice.
After-advice and around-advice can arrange to return some other value
by storing it in this variable.
</p></dd></dl>

<p>The argument <var class="var">name</var> is the name of the advice, a non-<code class="code">nil</code>
symbol.  The advice name uniquely identifies one piece of advice, within all
the pieces of advice in a particular class for a particular
<var class="var">function</var>.  The name allows you to refer to the piece of
advice&mdash;to redefine it, or to enable or disable it.
</p>
<p>The optional <var class="var">position</var> specifies where, in the current list of
advice of the specified <var class="var">class</var>, this new advice should be placed.
It should be either <code class="code">first</code>, <code class="code">last</code> or a number that specifies
a zero-based position (<code class="code">first</code> is equivalent to 0).  If no position
is specified, the default is <code class="code">first</code>.  Position values outside the
range of existing positions in this class are mapped to the beginning or
the end of the range, whichever is closer.  The <var class="var">position</var> value is
ignored when redefining an existing piece of advice.
</p>
<p>The optional <var class="var">arglist</var> can be used to define the argument list for
the sake of advice.  This becomes the argument list of the combined
definition that is generated in order to run the advice (see <a class="pxref" href="Combined-Definition.html">The Combined Definition</a>).  Therefore, the advice expressions can use the argument
variables in this list to access argument values.
</p>
<p>The argument list used in advice need not be the same as the argument
list used in the original function, but must be compatible with it, so
that it can handle the ways the function is actually called.  If two
pieces of advice for a function both specify an argument list, they must
specify the same argument list.
</p>
<p>See <a class="xref" href="Argument-Access-in-Advice.html">Argument Access in Advice</a>, for more information about argument
lists and advice, and a more flexible way for advice to access the
arguments.
</p>
<p>The remaining elements, <var class="var">flags</var>, are symbols that specify further
information about how to use this piece of advice.  Here are the valid
symbols and their meanings:
</p>
<dl class="table">
<dt><code class="code">activate</code></dt>
<dd><p>Activate the advice for <var class="var">function</var> now.  Changes in a function&rsquo;s
advice always take effect the next time you activate advice for the
function; this flag says to do so, for <var class="var">function</var>, immediately after
defining this piece of advice.
</p>
<a class="index-entry-id" id="index-forward-advice"></a>
<p>This flag has no immediate effect if <var class="var">function</var> itself is not defined yet (a
situation known as <em class="dfn">forward advice</em>), because it is impossible to
activate an undefined function&rsquo;s advice.  However, defining
<var class="var">function</var> will automatically activate its advice.
</p>
</dd>
<dt><code class="code">protect</code></dt>
<dd><p>Protect this piece of advice against non-local exits and errors in
preceding code and advice.  Protecting advice places it as a cleanup in
an <code class="code">unwind-protect</code> form, so that it will execute even if the
previous code gets an error or uses <code class="code">throw</code>.  See <a class="xref" href="Cleanups.html">Cleaning Up from Nonlocal Exits</a>.
</p>
</dd>
<dt><code class="code">compile</code></dt>
<dd><p>Compile the combined definition that is used to run the advice.  This
flag is ignored unless <code class="code">activate</code> is also specified.
See <a class="xref" href="Combined-Definition.html">The Combined Definition</a>.
</p>
</dd>
<dt><code class="code">disable</code></dt>
<dd><p>Initially disable this piece of advice, so that it will not be used
unless subsequently explicitly enabled.  See <a class="xref" href="Enabling-Advice.html">Enabling and Disabling Advice</a>.
</p>
</dd>
<dt><code class="code">preactivate</code></dt>
<dd><p>Activate advice for <var class="var">function</var> when this <code class="code">defadvice</code> is
compiled or macroexpanded.  This generates a compiled advised definition
according to the current advice state, which will be used during
activation if appropriate.  See <a class="xref" href="Preactivation.html">Preactivation</a>.
</p>
<p>This is useful only if this <code class="code">defadvice</code> is byte-compiled.
</p></dd>
</dl>

<p>The optional <var class="var">documentation-string</var> serves to document this piece of
advice.  When advice is active for <var class="var">function</var>, the documentation for
<var class="var">function</var> (as returned by <code class="code">documentation</code>) combines the
documentation strings of all the advice for <var class="var">function</var> with the
documentation string of its original function definition.
</p>
<p>The optional <var class="var">interactive-form</var> form can be supplied to change the
interactive behavior of the original function.  If more than one piece
of advice has an <var class="var">interactive-form</var>, then the first one (the one
with the smallest position) found among all the advice takes precedence.
</p>
<p>The possibly empty list of <var class="var">body-forms</var> specifies the body of the
advice.  The body of an advice can access or change the arguments, the
return value, the binding environment, and perform any other kind of
side effect.
</p>
<p><strong class="strong">Warning:</strong> When you advise a macro, keep in mind that macros are
expanded when a program is compiled, not when a compiled program is run.
All subroutines used by the advice need to be available when the byte
compiler expands the macro.
</p>
<dl class="first-deffn">
<dt class="deffn" id="index-ad_002dunadvise"><span class="category-def">Command: </span><span><strong class="def-name">ad-unadvise</strong> <var class="def-var-arguments">function</var><a class="copiable-link" href="#index-ad_002dunadvise"> &para;</a></span></dt>
<dd><p>This command deletes all pieces of advice from <var class="var">function</var>.
</p></dd></dl>

<dl class="first-deffn">
<dt class="deffn" id="index-ad_002dunadvise_002dall"><span class="category-def">Command: </span><span><strong class="def-name">ad-unadvise-all</strong><a class="copiable-link" href="#index-ad_002dunadvise_002dall"> &para;</a></span></dt>
<dd><p>This command deletes all pieces of advice from all functions.
</p></dd></dl>

</div>
<hr>
<div class="nav-panel">
<p>
Next: <a href="Around_002dAdvice.html">Around-Advice</a>, Previous: <a href="Simple-Advice.html">A Simple Advice Example</a>, Up: <a href="Advising-Functions.html">Advising Emacs Lisp Functions</a> &nbsp; [<a href="index.html#SEC_Contents" title="Table of contents" rel="contents">Contents</a>][<a href="Index.html" title="Index" rel="index">Index</a>]</p>
</div>



</body>
</html>
