<!DOCTYPE html>
<html>
<!-- Created by GNU Texinfo 7.1, https://www.gnu.org/software/texinfo/ -->
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<!-- This is the GNU Emacs Lisp Reference Manual
corresponding to Emacs version 27.2.

Copyright Â© 1990-1996, 1998-2021 Free Software Foundation,
Inc.

Permission is granted to copy, distribute and/or modify this document
under the terms of the GNU Free Documentation License, Version 1.3 or
any later version published by the Free Software Foundation; with the
Invariant Sections being "GNU General Public License," with the
Front-Cover Texts being "A GNU Manual," and with the Back-Cover
Texts as in (a) below.  A copy of the license is included in the
section entitled "GNU Free Documentation License."

(a) The FSF's Back-Cover Text is: "You have the freedom to copy and
modify this GNU manual.  Buying copies from the FSF supports it in
developing GNU and promoting software freedom." -->
<title>Argument Evaluation (GNU Emacs Lisp Reference Manual)</title>

<meta name="description" content="Argument Evaluation (GNU Emacs Lisp Reference Manual)">
<meta name="keywords" content="Argument Evaluation (GNU Emacs Lisp Reference Manual)">
<meta name="resource-type" content="document">
<meta name="distribution" content="global">
<meta name="Generator" content="makeinfo">
<meta name="viewport" content="width=device-width,initial-scale=1">

<link href="index.html" rel="start" title="Top">
<link href="Index.html" rel="index" title="Index">
<link href="index.html#SEC_Contents" rel="contents" title="Table of Contents">
<link href="Problems-with-Macros.html" rel="up" title="Problems with Macros">
<link href="Surprising-Local-Vars.html" rel="next" title="Surprising Local Vars">
<link href="Wrong-Time.html" rel="prev" title="Wrong Time">
<style type="text/css">
<!--
a.copiable-link {visibility: hidden; text-decoration: none; line-height: 0em}
div.example {margin-left: 3.2em}
span:hover a.copiable-link {visibility: visible}
-->
</style>
<link rel="stylesheet" type="text/css" href="./manual.css">


</head>

<body lang="en">
<div class="subsection-level-extent" id="Argument-Evaluation">
<div class="nav-panel">
<p>
Next: <a href="Surprising-Local-Vars.html" accesskey="n" rel="next">Local Variables in Macro Expansions</a>, Previous: <a href="Wrong-Time.html" accesskey="p" rel="prev">Wrong Time</a>, Up: <a href="Problems-with-Macros.html" accesskey="u" rel="up">Common Problems Using Macros</a> &nbsp; [<a href="index.html#SEC_Contents" title="Table of contents" rel="contents">Contents</a>][<a href="Index.html" title="Index" rel="index">Index</a>]</p>
</div>
<hr>
<h4 class="subsection" id="Evaluating-Macro-Arguments-Repeatedly"><span>14.5.2 Evaluating Macro Arguments Repeatedly<a class="copiable-link" href="#Evaluating-Macro-Arguments-Repeatedly"> &para;</a></span></h4>

<p>When defining a macro you must pay attention to the number of times
the arguments will be evaluated when the expansion is executed.  The
following macro (used to facilitate iteration) illustrates the
problem.  This macro allows us to write a for-loop construct.
</p>
<a class="index-entry-id" id="index-for"></a>
<div class="example">
<div class="group"><pre class="example-preformatted">(defmacro for (var from init to final do &amp;rest body)
  &quot;Execute a simple \&quot;for\&quot; loop.
For example, (for i from 1 to 10 do (print i)).&quot;
  (list 'let (list (list var init))
        (cons 'while
              (cons (list '&lt;= var final)
                    (append body (list (list 'inc var)))))))
</pre></div><pre class="example-preformatted">

</pre><div class="group"><pre class="example-preformatted">(for i from 1 to 3 do
   (setq square (* i i))
   (princ (format &quot;\n%d %d&quot; i square)))
&rarr;
</pre></div><div class="group"><pre class="example-preformatted">(let ((i 1))
  (while (&lt;= i 3)
    (setq square (* i i))
    (princ (format &quot;\n%d %d&quot; i square))
    (inc i)))
</pre></div><div class="group"><pre class="example-preformatted">

     -|1       1
     -|2       4
     -|3       9
&rArr; nil
</pre></div></div>

<p>The arguments <code class="code">from</code>, <code class="code">to</code>, and <code class="code">do</code> in this macro are
syntactic sugar; they are entirely ignored.  The idea is that you
will write noise words (such as <code class="code">from</code>, <code class="code">to</code>, and <code class="code">do</code>)
in those positions in the macro call.
</p>
<p>Here&rsquo;s an equivalent definition simplified through use of backquote:
</p>
<div class="example">
<div class="group"><pre class="example-preformatted">(defmacro for (var from init to final do &amp;rest body)
  &quot;Execute a simple \&quot;for\&quot; loop.
For example, (for i from 1 to 10 do (print i)).&quot;
  `(let ((,var ,init))
     (while (&lt;= ,var ,final)
       ,@body
       (inc ,var))))
</pre></div></div>

<p>Both forms of this definition (with backquote and without) suffer from
the defect that <var class="var">final</var> is evaluated on every iteration.  If
<var class="var">final</var> is a constant, this is not a problem.  If it is a more
complex form, say <code class="code">(long-complex-calculation x)</code>, this can slow
down the execution significantly.  If <var class="var">final</var> has side effects,
executing it more than once is probably incorrect.
</p>
<a class="index-entry-id" id="index-macro-argument-evaluation"></a>
<p>A well-designed macro definition takes steps to avoid this problem by
producing an expansion that evaluates the argument expressions exactly
once unless repeated evaluation is part of the intended purpose of the
macro.  Here is a correct expansion for the <code class="code">for</code> macro:
</p>
<div class="example">
<div class="group"><pre class="example-preformatted">(let ((i 1)
      (max 3))
  (while (&lt;= i max)
    (setq square (* i i))
    (princ (format &quot;%d      %d&quot; i square))
    (inc i)))
</pre></div></div>

<p>Here is a macro definition that creates this expansion:
</p>
<div class="example">
<div class="group"><pre class="example-preformatted">(defmacro for (var from init to final do &amp;rest body)
  &quot;Execute a simple for loop: (for i from 1 to 10 do (print i)).&quot;
  `(let ((,var ,init)
         (max ,final))
     (while (&lt;= ,var max)
       ,@body
       (inc ,var))))
</pre></div></div>

<p>Unfortunately, this fix introduces another problem,
described in the following section.
</p>
</div>
<hr>
<div class="nav-panel">
<p>
Next: <a href="Surprising-Local-Vars.html">Local Variables in Macro Expansions</a>, Previous: <a href="Wrong-Time.html">Wrong Time</a>, Up: <a href="Problems-with-Macros.html">Common Problems Using Macros</a> &nbsp; [<a href="index.html#SEC_Contents" title="Table of contents" rel="contents">Contents</a>][<a href="Index.html" title="Index" rel="index">Index</a>]</p>
</div>



</body>
</html>
