<!DOCTYPE html>
<html>
<!-- Created by GNU Texinfo 7.1, https://www.gnu.org/software/texinfo/ -->
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<!-- This is the GNU Emacs Lisp Reference Manual
corresponding to Emacs version 29.3.

Copyright Â© 1990-1996, 1998-2024 Free Software Foundation,
Inc.

Permission is granted to copy, distribute and/or modify this document
under the terms of the GNU Free Documentation License, Version 1.3 or
any later version published by the Free Software Foundation; with the
Invariant Sections being "GNU General Public License," with the
Front-Cover Texts being "A GNU Manual," and with the Back-Cover
Texts as in (a) below.  A copy of the license is included in the
section entitled "GNU Free Documentation License."

(a) The FSF's Back-Cover Text is: "You have the freedom to copy and
modify this GNU manual.  Buying copies from the FSF supports it in
developing GNU and promoting software freedom." -->
<title>Module Nonlocal (GNU Emacs Lisp Reference Manual)</title>

<meta name="description" content="Module Nonlocal (GNU Emacs Lisp Reference Manual)">
<meta name="keywords" content="Module Nonlocal (GNU Emacs Lisp Reference Manual)">
<meta name="resource-type" content="document">
<meta name="distribution" content="global">
<meta name="Generator" content="makeinfo">
<meta name="viewport" content="width=device-width,initial-scale=1">

<link href="index.html" rel="start" title="Top">
<link href="Index.html" rel="index" title="Index">
<link href="index.html#SEC_Contents" rel="contents" title="Table of Contents">
<link href="Writing-Dynamic-Modules.html" rel="up" title="Writing Dynamic Modules">
<link href="Module-Misc.html" rel="prev" title="Module Misc">
<style type="text/css">
<!--
a.copiable-link {visibility: hidden; text-decoration: none; line-height: 0em}
span:hover a.copiable-link {visibility: visible}
strong.def-name {font-family: monospace; font-weight: bold; font-size: larger}
ul.mark-minus {list-style-type: "\2212"}
-->
</style>
<link rel="stylesheet" type="text/css" href="./manual.css">


</head>

<body lang="en">
<div class="subsection-level-extent" id="Module-Nonlocal">
<div class="nav-panel">
<p>
Previous: <a href="Module-Misc.html" accesskey="p" rel="prev">Miscellaneous Convenience Functions for Modules</a>, Up: <a href="Writing-Dynamic-Modules.html" accesskey="u" rel="up">Writing Dynamically-Loaded Modules</a> &nbsp; [<a href="index.html#SEC_Contents" title="Table of contents" rel="contents">Contents</a>][<a href="Index.html" title="Index" rel="index">Index</a>]</p>
</div>
<hr>
<h4 class="subsection" id="Nonlocal-Exits-in-Modules"><span>E.8.5 Nonlocal Exits in Modules<a class="copiable-link" href="#Nonlocal-Exits-in-Modules"> &para;</a></span></h4>
<a class="index-entry-id" id="index-nonlocal-exits_002c-in-modules"></a>

<p>Emacs Lisp supports nonlocal exits, whereby program control is
transferred from one point in a program to another remote point.
See <a class="xref" href="Nonlocal-Exits.html">Nonlocal Exits</a>.  Thus, Lisp functions called by your module
might exit nonlocally by calling <code class="code">signal</code> or <code class="code">throw</code>, and
your module functions must handle such nonlocal exits properly.  Such
handling is needed because C programs will not automatically release
resources and perform other cleanups in these cases; your module code
must itself do it.  The module <abbr class="acronym">API</abbr> provides facilities for
that, described in this subsection.  They are generally available
since Emacs 25; those of them that became available in later releases
explicitly call out the first Emacs version where they became part of
the <abbr class="acronym">API</abbr>.
</p>
<p>When some Lisp code called by a module function signals an error or
throws, the nonlocal exit is trapped, and the pending exit and its
associated data are stored in the environment.  Whenever a nonlocal
exit is pending in the environment, any module <abbr class="acronym">API</abbr> function
called with a pointer to that environment will return immediately
without any processing (the functions <code class="code">non_local_exit_check</code>,
<code class="code">non_local_exit_get</code>, and <code class="code">non_local_exit_clear</code> are
exceptions from this rule).  If your module function then does nothing
and returns to Emacs, a pending nonlocal exit will cause Emacs to act
on it: signal an error or throw to the corresponding <code class="code">catch</code>.
</p>
<p>So the simplest &ldquo;handling&rdquo; of nonlocal exits in module functions is
to do nothing special and let the rest of your code to run as if
nothing happened.  However, this can cause two classes of problems:
</p>
<ul class="itemize mark-minus">
<li>Your module function might use uninitialized or undefined values,
since <abbr class="acronym">API</abbr> functions return immediately without producing the
expected results.

</li><li>Your module might leak resources, because it might not have the
opportunity to release them.
</li></ul>

<p>Therefore, we recommend that your module functions check for nonlocal
exit conditions and recover from them, using the functions described
below.
</p>
<dl class="first-deftypefn">
<dt class="deftypefn" id="index-non_005flocal_005fexit_005fcheck"><span class="category-def">Function: </span><span><code class="def-type">enum emacs_funcall_exit</code> <strong class="def-name">non_local_exit_check</strong> <code class="def-code-arguments">(emacs_env *<var class="var">env</var>)</code><a class="copiable-link" href="#index-non_005flocal_005fexit_005fcheck"> &para;</a></span></dt>
<dd><p>This function returns the kind of nonlocal exit condition stored in
<var class="var">env</var>.  The possible values are:
</p>
<a class="index-entry-id" id="index-emacs_005ffuncall_005fexit_002c-enumeration"></a>
<dl class="vtable">
<dt><a id="index-emacs_005ffuncall_005fexit_005freturn"></a><span><code class="code">emacs_funcall_exit_return</code><a class="copiable-link" href="#index-emacs_005ffuncall_005fexit_005freturn"> &para;</a></span></dt>
<dd><p>The last <abbr class="acronym">API</abbr> function exited normally.
</p></dd>
<dt><a id="index-emacs_005ffuncall_005fexit_005fsignal"></a><span><code class="code">emacs_funcall_exit_signal</code><a class="copiable-link" href="#index-emacs_005ffuncall_005fexit_005fsignal"> &para;</a></span></dt>
<dd><p>The last <abbr class="acronym">API</abbr> function signaled an error.
</p></dd>
<dt><a id="index-emacs_005ffuncall_005fexit_005fthrow"></a><span><code class="code">emacs_funcall_exit_throw</code><a class="copiable-link" href="#index-emacs_005ffuncall_005fexit_005fthrow"> &para;</a></span></dt>
<dd><p>The last <abbr class="acronym">API</abbr> function exited via <code class="code">throw</code>.
</p></dd>
</dl>
</dd></dl>

<dl class="first-deftypefn">
<dt class="deftypefn" id="index-non_005flocal_005fexit_005fget"><span class="category-def">Function: </span><span><code class="def-type">enum emacs_funcall_exit</code> <strong class="def-name">non_local_exit_get</strong> <code class="def-code-arguments">(emacs_env *<var class="var">env</var>, emacs_value *<var class="var">symbol</var>, emacs_value *<var class="var">data</var>)</code><a class="copiable-link" href="#index-non_005flocal_005fexit_005fget"> &para;</a></span></dt>
<dd><p>This function returns the kind of nonlocal exit condition stored in
<var class="var">env</var>, like <code class="code">non_local_exit_check</code> does, but it also returns
the full information about the nonlocal exit, if any.  If the return
value is <code class="code">emacs_funcall_exit_signal</code>, the function stores the
error symbol in <code class="code">*<var class="var">symbol</var></code> and the error data in
<code class="code">*<var class="var">data</var></code> (see <a class="pxref" href="Signaling-Errors.html">How to Signal an Error</a>).  If the return value is
<code class="code">emacs_funcall_exit_throw</code>, the function stores the <code class="code">catch</code>
tag symbol in <code class="code">*<var class="var">symbol</var></code> and the <code class="code">throw</code> value in
<code class="code">*<var class="var">data</var></code>.  The function doesn&rsquo;t store anything in memory
pointed by these arguments when the return value is
<code class="code">emacs_funcall_exit_return</code>.
</p></dd></dl>

<p>You should check nonlocal exit conditions where it matters: before you
allocated some resource or after you allocated a resource that might
need freeing, or where a failure means further processing is
impossible or infeasible.
</p>
<p>Once your module function detected that a nonlocal exit is pending, it
can either return to Emacs (after performing the necessary local
cleanup), or it can attempt to recover from the nonlocal exit.  The
following <abbr class="acronym">API</abbr> functions will help with these tasks.
</p>
<dl class="first-deftypefn">
<dt class="deftypefn" id="index-non_005flocal_005fexit_005fclear"><span class="category-def">Function: </span><span><code class="def-type">void</code> <strong class="def-name">non_local_exit_clear</strong> <code class="def-code-arguments">(emacs_env *<var class="var">env</var>)</code><a class="copiable-link" href="#index-non_005flocal_005fexit_005fclear"> &para;</a></span></dt>
<dd><p>This function clears the pending nonlocal exit conditions and data
from <var class="var">env</var>.  After calling it, the module <abbr class="acronym">API</abbr> functions
will work normally.  Use this function if your module function can
recover from nonlocal exits of the Lisp functions it calls and
continue, and also before calling any of the following two functions
(or any other <abbr class="acronym">API</abbr> functions, if you want them to perform
their intended processing when a nonlocal exit is pending).
</p></dd></dl>

<dl class="first-deftypefn">
<dt class="deftypefn" id="index-non_005flocal_005fexit_005fthrow"><span class="category-def">Function: </span><span><code class="def-type">void</code> <strong class="def-name">non_local_exit_throw</strong> <code class="def-code-arguments">(emacs_env *<var class="var">env</var>, emacs_value <var class="var">tag</var>, emacs_value <var class="var">value</var>)</code><a class="copiable-link" href="#index-non_005flocal_005fexit_005fthrow"> &para;</a></span></dt>
<dd><p>This function throws to the Lisp <code class="code">catch</code> symbol represented by
<var class="var">tag</var>, passing it <var class="var">value</var> as the value to return.  Your module
function should in general return soon after calling this function.
One use of this function is when you want to re-throw a non-local exit
from one of the called <abbr class="acronym">API</abbr> or Lisp functions.
</p></dd></dl>

<dl class="first-deftypefn">
<dt class="deftypefn" id="index-non_005flocal_005fexit_005fsignal"><span class="category-def">Function: </span><span><code class="def-type">void</code> <strong class="def-name">non_local_exit_signal</strong> <code class="def-code-arguments">(emacs_env *<var class="var">env</var>, emacs_value <var class="var">symbol</var>, emacs_value <var class="var">data</var>)</code><a class="copiable-link" href="#index-non_005flocal_005fexit_005fsignal"> &para;</a></span></dt>
<dd><p>This function signals the error represented by the error symbol
<var class="var">symbol</var> with the specified error data <var class="var">data</var>.  The module
function should return soon after calling this function.  This
function could be useful, e.g., for signaling errors from module
functions to Emacs.
</p></dd></dl>


</div>
<hr>
<div class="nav-panel">
<p>
Previous: <a href="Module-Misc.html">Miscellaneous Convenience Functions for Modules</a>, Up: <a href="Writing-Dynamic-Modules.html">Writing Dynamically-Loaded Modules</a> &nbsp; [<a href="index.html#SEC_Contents" title="Table of contents" rel="contents">Contents</a>][<a href="Index.html" title="Index" rel="index">Index</a>]</p>
</div>



</body>
</html>
